/**
 * @license MIT
 * Copyright (c) 2025 SGNL.ai, Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";const e="SGNL-CAEP-Hub/2.0";async function s(s){const t=s.environment||{},o=s.secrets||{};if(o.BEARER_AUTH_TOKEN){const e=o.BEARER_AUTH_TOKEN;return e.startsWith("Bearer ")?e:`Bearer ${e}`}if(o.BASIC_PASSWORD&&o.BASIC_USERNAME){return`Basic ${btoa(`${o.BASIC_USERNAME}:${o.BASIC_PASSWORD}`)}`}if(o.OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN){const e=o.OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN;return e.startsWith("Bearer ")?e:`Bearer ${e}`}if(o.OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET){const s=t.OAUTH2_CLIENT_CREDENTIALS_TOKEN_URL,n=t.OAUTH2_CLIENT_CREDENTIALS_CLIENT_ID,r=o.OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET;if(!s||!n)throw new Error("OAuth2 Client Credentials flow requires TOKEN_URL and CLIENT_ID in env");const a=await async function(s){const{tokenUrl:t,clientId:o,clientSecret:n,scope:r,audience:a,authStyle:c}=s;if(!t||!o||!n)throw new Error("OAuth2 Client Credentials flow requires tokenUrl, clientId, and clientSecret");const i=new URLSearchParams;i.append("grant_type","client_credentials"),r&&i.append("scope",r),a&&i.append("audience",a);const E={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json","User-Agent":e};if("InParams"===c)i.append("client_id",o),i.append("client_secret",n);else{const e=btoa(`${o}:${n}`);E.Authorization=`Basic ${e}`}const u=await fetch(t,{method:"POST",headers:E,body:i.toString()});if(!u.ok){let e;try{const s=await u.json();e=JSON.stringify(s)}catch{e=await u.text()}throw new Error(`OAuth2 token request failed: ${u.status} ${u.statusText} - ${e}`)}const l=await u.json();if(!l.access_token)throw new Error("No access_token in OAuth2 response");return l.access_token}({tokenUrl:s,clientId:n,clientSecret:r,scope:t.OAUTH2_CLIENT_CREDENTIALS_SCOPE,audience:t.OAUTH2_CLIENT_CREDENTIALS_AUDIENCE,authStyle:t.OAUTH2_CLIENT_CREDENTIALS_AUTH_STYLE});return`Bearer ${a}`}throw new Error("No authentication configured. Provide one of: BEARER_AUTH_TOKEN, BASIC_USERNAME/BASIC_PASSWORD, OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN, or OAUTH2_CLIENT_CREDENTIALS_*")}async function t(e,s,t,o){const n=`${t}${e}`;return await fetch(n,{method:s,headers:o})}var o={invoke:async(o,n)=>{console.log("Starting Salesforce session revocation");const{username:r}=o,a=function(e,s){const t=s.environment||{},o=e?.address||t.ADDRESS;if(!o)throw new Error("No URL specified. Provide address parameter or ADDRESS environment variable");return o.endsWith("/")?o.slice(0,-1):o}(o,n),c=await async function(t){return{Authorization:await s(t),Accept:"application/json","Content-Type":"application/json","User-Agent":e}}(n);console.log(`Processing username: ${r}`);try{const e=`/services/data/v61.0/query?q=SELECT+Id+FROM+User+WHERE+username+LIKE+'${encodeURIComponent(r)}'+ORDER+BY+Id+ASC`;console.log("Step 1: Querying for user ID...");const s=await t(e,"GET",a,c);if(!s.ok)throw new Error(`Failed to query user: ${s.status} ${s.statusText}`);const o=await s.json();if(!o.records||0===o.records.length)throw new Error(`User not found: ${r}`);const n=o.records[0].Id;console.log(`Found user ID: ${n}`);const i=`/services/data/v61.0/query?q=SELECT+Id,UsersId+FROM+AuthSession+WHERE+UsersId='${n}'+AND+IsCurrent=false+ORDER+BY+Id+ASC`;console.log("Step 2: Querying for user sessions...");const E=await t(i,"GET",a,c);if(!E.ok)throw new Error(`Failed to query sessions: ${E.status} ${E.statusText}`);const u=(await E.json()).records||[];if(console.log(`Found ${u.length} sessions to revoke`),0===u.length)return console.log("No sessions found to revoke"),{status:"success",username:r,userId:n,sessionsRevoked:0,processed_at:(new Date).toISOString(),address:a};console.log("Step 3: Revoking sessions...");let l=0;for(const e of u){const s=`/services/data/v61.0/sobjects/AuthSession/${e.Id}`;try{const o=await t(s,"DELETE",a,c);204===o.status||404===o.status||o.ok?(l++,console.log(`Successfully revoked session: ${e.Id}`)):console.warn(`Failed to revoke session ${e.Id}: ${o.status} ${o.statusText}`)}catch(s){console.warn(`Error revoking session ${e.Id}: ${s.message}`)}}return console.log(`Successfully revoked ${l} out of ${u.length} sessions`),{status:"success",username:r,userId:n,sessionsRevoked:l,processed_at:(new Date).toISOString(),address:a}}catch(e){throw console.error(`Failed to revoke sessions for user ${r}: ${e.message}`),e}},error:async(e,s)=>{const{error:t}=e;throw t},halt:async(e,s)=>{const{reason:t,username:o}=e;return console.log(`Session revocation is being halted (${t}) for user: ${o}`),console.log("Halting session revocation process - no cleanup needed"),{status:"halted",username:o||"unknown",reason:t,halted_at:(new Date).toISOString()}}};module.exports=o;
